var $=jQuery.noConflict();
$(document).ready(function() {
    variable = $('.lang_comments').data('value');
    variable = atob(variable);
    variable = JSON.parse(variable);
    
    // Popup hĂ¬nh áº£nh
    $('body').on('click', '.comments .popup-image', function(e) {
        e.preventDefault();
        e.stopImmediatePropagation();
        src = $(this).data('image');
        $(this).closest('.comments').find('.previews').find('.comments-popup__body').find('img').attr('src', src);
        $(this).closest('.comments').find('.previews').addClass('open');
        $('body').css('overflow', 'hidden');
    });

    // áº¢nh preview
    $('body').on('change', 'input[name=comment_file]', function(e) {
        e.preventDefault();
        html_image = '';
        file = this.files;
        check_size = 0;
        check_extention = 0;
        allowed_size = variable.allowed_size; // Tá»•ng kĂ­ch thÆ°á»›c cĂ¡c file lĂ  Ä‘Æ°á»£c dáº·t trong config
        allowed_extention = ['jpg','jpeg','png']; // Chá»‰ cho phĂ©p upload má»™t sá»‘ file nháº¥t Ä‘á»‹nh

        $.each(file,function(index,file_data) {
            if (file_data.size > allowed_size) {
                check_size = 1;
            }
            if ($.inArray(file_data.name.split('.').pop().toLowerCase(), allowed_extention) == -1) {
                check_extention = 1;
            }
            image_preview = URL.createObjectURL(file_data);
            html_image += '<div class="image"><img src="'+image_preview+'"></div>';
        });
        if (check_size == 1) {
            alertTextCmt(variable.valid_size+' '+formatSizeCommentFile(allowed_size))
            $(this).val('');
            $(this).closest('.comments-add').find('.comments-add__preview').empty();  
        } else if (check_extention == 1) {
            alertTextCmt(variable.valid_extention+' '+allowed_extention.join(', '));
            $(this).val('');
            $(this).closest('.comments-add').find('.comments-add__preview').empty();  
        } else {
            $(this).closest('.comments-add').find('.comments-add__preview').empty().append(html_image);
        }
    });

    // load thĂªm bĂ¬nh luáº­n
    $('body').on('click', '.comments *[data-comments_loadmore]', function(e) {
        e.preventDefault();
        e.stopImmediatePropagation();
        type = $(this).closest('.comments').data('type');
        type_id = $(this).closest('.comments').data('type_id');
        pageCmt = parseInt($(this).data('page_cmt'));
        pageCmt = pageCmt+1;
        if ($(this).closest('.comments').find('.comments-info__filter').find('input[name=keyword]').val() == '') {
            commentLoad(type, type_id, pageCmt, $(this));
        } else {
            value = $(this).closest('.comments').find('.comments-info__filter').find('input[name=keyword]').val();
            commentSearch(type, type_id, value, pageCmt, $(this), false);
        }
    });

    // TĂ¬m kiáº¿m bĂ¬nh luáº­n
    start = null;
    $('body').on('click', '.comments-info__filter button[type=submit]', function(e) {
        e.preventDefault();
        e.stopImmediatePropagation();
        e = $(this);
        clearTimeout(start);
        comments = e.closest('.comments');
        type = comments.data('type');
        type_id = comments.data('type_id');
        value = e.closest('.comments-info__filter').find('input[name=keyword]').val();
        commentSearch(type, type_id, value, 1, e, true);
    })
    $('body').on('keyup', '.comments-info__filter input[name=keyword]', function(e) {
        e.preventDefault();
        e.stopImmediatePropagation();
        e = $(this);
        clearTimeout(start);
        value = e.val();
        start = setTimeout(function() {
            e.closest('.comments-info__filter').find('button[type=submit]').click();
        }, 2000);
    })

    // Tráº£ lá»i bĂ¬nh luáº­n
    $('body').on('click', '.comments *[data-reply]', function(e) {
        e.preventDefault();
        e.stopImmediatePropagation();
        item = $(this).closest('.item[data-comment_id]');
        tags = $(this).data('reply');
        $('.item-reply').find('.comments-add').css('display', 'none');
        $('.comments-add__moreinfo').css('display', 'none');
        item.find('.item-reply').find('.comments-add').slideDown();
        item.find('.item-reply').find('.comments-add').find('.comments-add__form-field').val(tags);
    });

    content = null;
    file_data = null;
    parent_id = null;
    // Hiá»ƒn thá»‹ thĂ´ng tin thĂªm
    $('body').on('click', '.comments *[data-comments_moreinfo]', function(e) {
        e.preventDefault();
        e.stopImmediatePropagation();
        $(this).closest('.comments').find('.moreinfo').addClass('open');
        $('body').css('overflow', 'hidden');
        content = $(this).closest('.comments-add').find('*[name=content]').val();
        parent_id = $(this).data('comment_id');
        if (variable.upload_image == true) { 
            file_data = $(this).closest('.comments-add').find('*[name=comment_file]').prop("files"); 
        }
    })

    // ÄĂ³ng popup
    $('body').on('click', '.comments *[data-comments_close]', function(e) {
        e.preventDefault();
        e.stopImmediatePropagation();
        $(this).closest('.comments-popup').removeClass('open');
        $('body').css('overflow', 'auto');
        content = null;
        file_data = null;
        parent_id = null;
    })

    $('body').on('click', '.star-button', function(e) {
        var rank = $(this).data('poin');
        $(this).closest('.moreinfo').find('*[name=rank]').val(rank);
    })

    function getCookie(key) {
        var keyValue = document.cookie.match('(^|;) ?' + key + '=([^;]*)(;|$)');
        return keyValue ? keyValue[2] : null;
    }
    // thĂªm cookie
    function setCookie(key, value) {
        var expires = new Date();
        expires.setTime(expires.getTime() + (1 * 24 * 60 * 60 * 1000));
        document.cookie = key + '=' + value + ';path=/;expires=' + expires.toUTCString();
    }

    // ThĂªm bĂ¬nh luáº­n
    $('body').on('click', '.comments *[data-comments_submit]', function(e) {
        e.preventDefault();
        e.stopImmediatePropagation();
        comments = $(this).closest('.comments');
        rank = $(this).closest('.moreinfo').find('*[name=rank]').val();
        type = comments.data('type');
        type_id = comments.data('type_id');
        name = $(this).closest('.moreinfo').find('*[name=name]').val();
        content = $(this).closest('.moreinfo').find('*[name=content]').val();
        email = $(this).closest('.moreinfo').find('*[name=email]').val();
        parent_id = $(this).closest('.moreinfo').find('*[name=comment_id]').val();
        save_info = $('input[name="signin-remember"]:checked').val();
        $('.validate-message').css({'display':'none'});
        if (content == '') {
            $('.validate-comments').css({'display':'inherit'});
        }else if(name == ''){
            $('.validate-name').css({'display':'inherit'});
        }else if (email != '' && !validateEmailCmt(email)) {
            $('.check-email').css({'display':'inherit'});
        }else {
            if(save_info == 1){
                var name_cmt = getCookie("name_cmt");
                var email_cmt = getCookie("email_cmt")
                if (name_cmt == null) {
                    setCookie('name_cmt',name);
                }
                if (email_cmt == null) {
                    setCookie('email_cmt',email);
                }
            }
            form_data = new FormData();
            form_data.append('rank', rank);
            form_data.append('type', type);
            form_data.append('type_id', type_id);
            form_data.append('content', content);
            form_data.append('name', name);
            form_data.append('email', email);
            form_data.append('parent_id', parent_id);
            if (file_data != null) {
                $.each(file_data ,function(index, file) {
                    form_data.append('files[]', file);
                });
            }
            commendAdd(type, type_id, $(this), form_data);
            $('.form-control').val('');
        }
    })
});
// Alert
function alertTextCmt(text) {
    alert(text);
}
// format Ä‘á»‹nh dáº¡ng kĂ­ch thÆ°á»›c
function formatSizeCommentFile(bytes){
    if      (bytes >= 1073741824) { bytes = (bytes / 1073741824).toFixed(2) + " GB"; }
    else if (bytes >= 1048576)    { bytes = (bytes / 1048576).toFixed(2) + " MB"; }
    else if (bytes >= 1024)       { bytes = (bytes / 1024).toFixed(2) + " KB"; }
    else if (bytes > 1)           { bytes = bytes + " bytes"; }
    else if (bytes == 1)          { bytes = bytes + " byte"; }
    else                          { bytes = "0 bytes"; }
    return bytes;
}

// check Ä‘á»‹nh dáº¡ng email
function validateEmailCmt(email) {
    var re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
    return re.test(String(email).toLowerCase());
}
// check Ä‘á»‹nh dáº¡ng Ä‘iá»‡n thoáº¡i
function validatePhoneCmt(phone) {
    var flag = false;
    phone = phone.trim();
    phone = phone.replace('(+84)', '0');
    phone = phone.replace('+84', '0');
    phone = phone.replace('0084', '0');
    phone = phone.replace(/ /g, '');
    if (phone != '') {
        if (phone.length >= 9 && phone.length <=11) {
            flag = true;
        } else {
            flag = false;
        }
    }
    return flag;
}

function commentLoad(type, type_id, pageCmt, this_element, reload) {
    data = {
        type: type,
        type_id: type_id,
        pageCmt: pageCmt,
    };
    $.ajax({
        headers: {
            'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
        },
        type: 'POST',
        url: variable.ajax_load_url,
        data: data,
        beforeSend: function(){
            $(".comments-loading").css({visibility:"visible", opacity: 0.0}).animate({opacity: 1.0},200);
        },
        success:function(result) {
            $(".comments-loading").animate({opacity: 0.0}, 200, function(){
                $(".comments-loading").css("visibility","hidden");
            });
            // Thay Ä‘á»•i sá»‘ lÆ°á»£ng bĂ¬nh luáº­n á»Ÿ tá»•ng bĂ¬nh luáº­n
            this_element.closest('.comments').find('.total-comment').text(result.comment_totals);

            if (result.has_more == false) {
                // has_more báº±ng false thĂ¬ áº©n box xem thĂªm
                this_element.closest('.comments').find('.comments-loadmore').css('display', 'none');
            } else {
                // Hiá»ƒn thá»‹ box xem thĂªm
                this_element.closest('.comments').find('.comments-loadmore').css('display', 'block');
            }

            // reload lĂ  true thĂ¬ sáº½ load láº¡i box bĂ¬nh luáº­n
            if (reload == true) {
                // lĂ m trá»‘ng danh sĂ¡ch sĂ¡ch vĂ  Ä‘á»• láº¡i
                this_element.closest('.comments').find('.comments-list .list-comments').empty().append(result.html);
            } else {
                // Äá»• tiáº¿p bĂ¬nh luáº­n dÆ°á»›i bĂ¬nh luáº­n hiá»‡n cĂ³
                this_element.closest('.comments').find('.comments-list .list-comments').append(result.html);
            }

            // Set láº¡i giĂ¡ trá»‹ sá»‘ trang hiá»‡n táº¡i á»Ÿ nĂºt xem thĂªm
            this_element.closest('.comments').find('*[data-comments_loadmore]').data('page_cmt', pageCmt).attr('data-page_cmt', pageCmt);
            
            // Set láº¡i giĂ¡ trá»‹ Ă´ tĂ¬m kiáº¿m vĂ¨ rá»—ng
            this_element.closest('.comments').find('.comments-info__filter').find('input[name=keyword]').val('');
        },
        error: function (error) {
            /* CĂ³ lá»—i sáº½ Ă¢n Module Loading vĂ  thĂ´ng bĂ¡o */
            $(".comments-loading").animate({opacity: 0.0}, 200, function(){
                $(".comments-loading").css("visibility","hidden");
            });
            alertTextCmt(variable.ajax_load_error_text);
        }
    })
}

// ThĂªm bĂ¬nh luáº­n
function commendAdd(type, type_id, this_element, form_data) {
    $.ajax({
        headers: {
            'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
        },
        type: 'POST',
        url: variable.ajax_add_url,
        data: form_data,
        enctype: 'multipart/form-data',
        processData: false,
        contentType: false,
        beforeSend: function(){
            $(".comments-loading").css({visibility:"visible", opacity: 0.0}).animate({opacity: 1.0},200);
        },
        success:function(result){
            $(".comments-loading").animate({opacity: 0.0}, 200, function(){
                $(".comments-loading").css("visibility","hidden");
            });
            if (result.status == 2) {
                alertTextCmt(result.message);
            } else {
                // Reload bĂ¬nh luáº­n
                commentLoad(type, type_id, 1, this_element, true);
                // Set cĂ¡c giĂ¡ trá»‹ táº¡i form vá» rá»—ng
                this_element.closest('.comments').find('*[name=content]').val('');
                this_element.closest('.comments').find('*[name=name]').val('');
                this_element.closest('.comments').find('*[name=email]').val('');
                this_element.closest('.comments').find('*[name=parent_id]').val('');
                // Set láº¡i giĂ¡ trá»‹ sá»‘ trang hiá»‡n táº¡i á»Ÿ nĂºt xem thĂªm
                this_element.closest('.comments').find('*[data-page_cmt]').attr('data-page_cmt', 1).data('page_cmt', 1);
                // LĂ m trá»‘ng box review áº£nh
                this_element.closest('.comments').find('.comments-add__preview').empty();
                // áº©n box thĂ´ng tin ngÆ°á»i dĂ¹ng
                this_element.closest('.comments').find('.moreinfo').removeClass('open');
                $('body').css('overflow', 'auto');
            }
        },
        error: function (error) {
            /* CĂ³ lá»—i sáº½ Ă¢n Module Loading vĂ  thĂ´ng bĂ¡o */
            $(".comments-loading").animate({opacity: 0.0}, 200, function(){
                $(".comments-loading").css("visibility","hidden");
            });
            alertTextCmt(variable.ajax_load_error_text);
        }
    })
}

function commentSearch(type, type_id, keyword, pageCmt, this_element, reload) {
    data = {
        type: type,
        type_id: type_id,
        keyword: keyword,
        pageCmt: pageCmt,
    };
    $.ajax({
        headers: {
            'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
        },
        type: 'POST',
        url: variable.ajax_search_url,
        data: data,
        beforeSend: function(){
            $(".comments-loading").css({visibility:"visible", opacity: 0.0}).animate({opacity: 1.0},200);
        },
        success:function(result) {
            $(".comments-loading").animate({opacity: 0.0}, 200, function(){
                $(".comments-loading").css("visibility","hidden");
            });

            if (result.has_more == false) {
                // has_more báº±ng false thĂ¬ áº©n box xem thĂªm
                this_element.closest('.comments').find('.comments-loadmore').css('display', 'none');
            } else {
                // Hiá»ƒn thá»‹ box xem thĂªm
                this_element.closest('.comments').find('.comments-loadmore').css('display', 'block');
            }

            // reload lĂ  true thĂ¬ sáº½ load láº¡i box bĂ¬nh luáº­n
            if (reload == true) {
                // lĂ m trá»‘ng danh sĂ¡ch sĂ¡ch vĂ  Ä‘á»• láº¡i
                this_element.closest('.comments').find('.comments-list .list-comments').empty().append(result.html);
            } else {
                // Äá»• tiáº¿p bĂ¬nh luáº­n dÆ°á»›i bĂ¬nh luáº­n hiá»‡n cĂ³
                this_element.closest('.comments').find('.comments-list .list-comments').append(result.html);
            }
            // Set láº¡i giĂ¡ trá»‹ sá»‘ trang hiá»‡n táº¡i á»Ÿ nĂºt xem thĂªm
            this_element.closest('.comments').find('*[data-comments_loadmore]').data('page_cmt', pageCmt).attr('data-page_cmt', pageCmt);
        },
        error: function (error) {
            /* CĂ³ lá»—i sáº½ Ă¢n Module Loading vĂ  thĂ´ng bĂ¡o */
            $(".comments-loading").animate({opacity: 0.0}, 200, function(){
                $(".comments-loading").css("visibility","hidden");
            });
            alertTextCmt(variable.ajax_load_error_text);
        }
    })
}